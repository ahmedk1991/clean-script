#!/bin/bash
# kvm-node2-reset.sh

echo "=== KVM NODE2 FULL SETUP (192.168.1.12) ==="

# 1. Cleanup VMs
sudo virsh list --all --name | while read vm; do
    [ -n "$vm" ] && sudo virsh destroy "$vm" 2>/dev/null
    [ -n "$vm" ] && sudo virsh undefine "$vm" --remove-all-storage 2>/dev/null
done

# 2. Cleanup storage pools
sudo virsh pool-destroy nfs-pool 2>/dev/null || true
sudo virsh pool-undefine nfs-pool 2>/dev/null || true

# 3. Unmount and cleanup directories
sudo umount -l /mnt/nfs/kvm /mnt/nfs/isos 2>/dev/null || true
sudo rm -rf /mnt/nfs
sudo mkdir -p /mnt/nfs/{kvm,isos}

# 4. Configure fstab
echo "Configuring /etc/fstab..."
# Backup existing fstab
sudo cp /etc/fstab /etc/fstab.backup.$(date +%Y%m%d)

# Add NFS mounts to fstab
if ! grep -q "/mnt/nfs/kvm" /etc/fstab; then
    echo "# NFS mounts for KVM cluster" | sudo tee -a /etc/fstab
    echo "192.168.1.10:/srv/nfs/kvm  /mnt/nfs/kvm   nfs  defaults,_netdev,noatime,vers=4.2  0  0" | sudo tee -a /etc/fstab
    echo "192.168.1.10:/srv/nfs/isos /mnt/nfs/isos  nfs  defaults,_netdev,noatime,vers=4.2  0  0" | sudo tee -a /etc/fstab
fi

# 5. Mount NFS
echo "Mounting NFS..."
sudo mount -a
if [ $? -eq 0 ]; then
    echo "✓ NFS mounts successful"
else
    echo "✗ NFS mounts failed, checking NFS server..."
    ping -c 2 192.168.1.10
    showmount -e 192.168.1.10
    exit 1
fi

# 6. Create storage pool
echo "Creating storage pool..."
sudo virsh pool-define-as nfs-pool netfs \
    --source-host 192.168.1.10 \
    --source-path /srv/nfs/kvm \
    --target /mnt/nfs/kvm

sudo virsh pool-build nfs-pool
sudo virsh pool-start nfs-pool
sudo virsh pool-autostart nfs-pool

# 7. Set permissions
sudo chown -R libvirt-qemu:kvm /mnt/nfs/kvm
sudo chmod 775 /mnt/nfs/kvm

# 8. Configure live migration
echo "Configuring live migration..."
sudo sed -i 's/^#listen_tcp.*/listen_tcp = 1/' /etc/libvirt/libvirtd.conf
sudo sed -i 's/^#auth_tcp.*/auth_tcp = "none"/' /etc/libvirt/libvirtd.conf
echo 'LIBVIRTD_ARGS="--listen"' | sudo tee -a /etc/default/libvirtd
sudo systemctl restart libvirtd

# 9. Verify
echo "=== VERIFICATION ==="
sudo virsh pool-list --all
ls -la /mnt/nfs/kvm/
mount | grep nfs
cat /etc/fstab | grep nfs

echo "=== NODE2 READY ==="
